<div class="it-wrapper">
  <div class="it-layout">

    <!-- ‚îÄ‚îÄ Initiative table card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="it-card">
      <div class="it-header">
        <mat-icon class="it-header__icon">shield</mat-icon>
        <h2 class="it-header__title">Sledov√°n√≠ iniciativy</h2>
      </div>
      <p class="it-notice">Data se ukl√°daj√≠ pouze v tomto prohl√≠≈æeƒçi ‚Äî na jin√©m za≈ô√≠zen√≠ budou ≈ô√°dky pr√°zdn√©.</p>

      <div class="it-col-headers">
        <span class="it-col-header it-col-header--indicator"></span>
        <span class="it-col-header it-col-header--sm">‚öî Init.</span>
        <span class="it-col-header it-col-header--name">üë§ Jm√©no</span>
        <span class="it-col-header it-col-header--sm">üõ° Oƒå</span>
        <span class="it-col-header it-col-header--sm">‚ù§ HP</span>
        <span class="it-col-header it-col-header--icon"></span>
        <span class="it-col-header it-col-header--icon"></span>
      </div>

      <div class="it-rows">
        @for (row of rows(); track $index) {
          <div
            class="it-row"
            [class.it-row--odd]="$index % 2 === 1"
            [class.it-row--active]="$index === activeIndex()"
            [class.it-row--selected]="selectedRowIndex() === $index"
          >
            <span class="it-turn-indicator">{{ $index === activeIndex() ? '‚ñ∂' : '' }}</span>
            <input [(ngModel)]="row.initiative" type="number" class="it-input it-input--sm" placeholder="‚Äî" />
            <input [(ngModel)]="row.name" type="text" class="it-input it-input--name" placeholder="N√°zev / jm√©no" />
            <input [(ngModel)]="row.ac" type="number" class="it-input it-input--sm" placeholder="‚Äî" />
            <input [(ngModel)]="row.hp" type="number" class="it-input it-input--sm" placeholder="‚Äî" />
            <button
              mat-icon-button
              type="button"
              class="it-lookup-btn"
              [class.it-lookup-btn--active]="selectedRowIndex() === $index"
              [class.it-lookup-btn--loading]="loadingIndex() === $index"
              title="Vyhledat p≈ô√≠≈°eru"
              (click)="lookupMonster(row.name, $index)"
            >
              <mat-icon>{{ loadingIndex() === $index ? 'hourglass_empty' : 'search' }}</mat-icon>
            </button>
            <button mat-icon-button type="button" class="it-remove-btn" title="Odstranit ≈ô√°dek" (click)="removeRow($index)">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }
      </div>

      <div class="it-actions">
        <button type="button" class="it-btn it-btn--add" (click)="addRow()">
          <mat-icon>add</mat-icon> P≈ôidat
        </button>
        <button type="button" class="it-btn it-btn--next" (click)="nextRow()">
          <mat-icon>arrow_downward</mat-icon> Dal≈°√≠ tah
        </button>
        <button type="button" class="it-btn it-btn--sort" (click)="sortRows()">
          <mat-icon>sort</mat-icon> Se≈ôadit
        </button>
        <button type="button" class="it-btn it-btn--save" (click)="save()">
          <mat-icon>save</mat-icon> Ulo≈æit
        </button>
      </div>

      @if (savedMessage()) {
        <p class="it-saved-msg">‚úì Ulo≈æeno do prohl√≠≈æeƒçe</p>
      }
    </div>

    <!-- ‚îÄ‚îÄ Monster detail card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    @if (monsterData() || monsterError() || loadingIndex() !== null) {
      <div class="m-card">
        <button class="m-close" (click)="closeMonster()" title="Zav≈ô√≠t">‚úï</button>

        @if (loadingIndex() !== null && !monsterData() && !monsterError()) {
          <div class="m-loading">
            <mat-icon class="m-loading__icon">hourglass_empty</mat-icon>
            <span>Naƒç√≠t√°m p≈ô√≠≈°eru‚Ä¶</span>
          </div>
        }

        @if (monsterError()) {
          <div class="m-error">‚ö† {{ monsterError() }}</div>
        }

        @if (monsterData(); as m) {
          <div class="m-name">{{ m.name }}</div>
          <div class="m-meta">
            {{ m.size }} {{ m.type }}
            @if (m.subtype) { ({{ m.subtype }}) }
            @if (m.alignment) { ¬∑ {{ m.alignment }} }
          </div>

          <div class="m-rule"></div>

          <!-- Core stat pills -->
          <div class="m-stat-row">
            @if (m.armor_class?.length) {
              <div class="m-stat-pill">
                <span class="m-stat-pill__label">Oƒå</span>
                <span class="m-stat-pill__val">
                  {{ m.armor_class[0].value }}
                  @if (m.armor_class[0].type) { <small>({{ m.armor_class[0].type }})</small> }
                </span>
              </div>
            }
            @if (m.hit_points) {
              <div class="m-stat-pill">
                <span class="m-stat-pill__label">≈ΩB</span>
                <span class="m-stat-pill__val">
                  {{ m.hit_points }}
                  @if (m.hit_dice) { <small>({{ m.hit_dice }})</small> }
                </span>
              </div>
            }
            @if (m.challenge_rating != null) {
              <div class="m-stat-pill">
                <span class="m-stat-pill__label">CR</span>
                <span class="m-stat-pill__val">{{ m.challenge_rating }}</span>
              </div>
            }
            @if (m.xp) {
              <div class="m-stat-pill">
                <span class="m-stat-pill__label">XP</span>
                <span class="m-stat-pill__val">{{ m.xp }}</span>
              </div>
            }
            @if (m.proficiency_bonus) {
              <div class="m-stat-pill">
                <span class="m-stat-pill__label">Zdatnost</span>
                <span class="m-stat-pill__val">+{{ m.proficiency_bonus }}</span>
              </div>
            }
          </div>

          <!-- Speed -->
          @if (m.speed && hasSpeed(m)) {
            <div class="m-line">
              <b>Pohyb:</b>
              @if (m.speed.walk)   { <span>ch≈Øze {{ m.speed.walk }}</span> }
              @if (m.speed.swim)   { <span>plav√°n√≠ {{ m.speed.swim }}</span> }
              @if (m.speed.fly)    { <span>let {{ m.speed.fly }}</span> }
              @if (m.speed.burrow) { <span>hrab√°n√≠ {{ m.speed.burrow }}</span> }
              @if (m.speed.climb)  { <span>≈°plh√°n√≠ {{ m.speed.climb }}</span> }
            </div>
          }

          <div class="m-rule"></div>

          <!-- Ability scores -->
          <div class="m-abilities">
            <div class="m-ab"><div class="m-ab__lbl">SIL</div><div class="m-ab__val">{{ m.strength }}</div><div class="m-ab__mod">{{ mod(m.strength) }}</div></div>
            <div class="m-ab"><div class="m-ab__lbl">OBR</div><div class="m-ab__val">{{ m.dexterity }}</div><div class="m-ab__mod">{{ mod(m.dexterity) }}</div></div>
            <div class="m-ab"><div class="m-ab__lbl">ODL</div><div class="m-ab__val">{{ m.constitution }}</div><div class="m-ab__mod">{{ mod(m.constitution) }}</div></div>
            <div class="m-ab"><div class="m-ab__lbl">INT</div><div class="m-ab__val">{{ m.intelligence }}</div><div class="m-ab__mod">{{ mod(m.intelligence) }}</div></div>
            <div class="m-ab"><div class="m-ab__lbl">MDR</div><div class="m-ab__val">{{ m.wisdom }}</div><div class="m-ab__mod">{{ mod(m.wisdom) }}</div></div>
            <div class="m-ab"><div class="m-ab__lbl">CHA</div><div class="m-ab__val">{{ m.charisma }}</div><div class="m-ab__mod">{{ mod(m.charisma) }}</div></div>
          </div>

          <div class="m-rule"></div>

          <!-- Properties -->
          @if (m.proficiencies?.length)          { <div class="m-prop"><b>Zdatnosti:</b> {{ profList(m) }}</div> }
          @if (m.damage_vulnerabilities?.length) { <div class="m-prop"><b>Zranitelnosti:</b> {{ m.damage_vulnerabilities.join(', ') }}</div> }
          @if (m.damage_resistances?.length)     { <div class="m-prop"><b>Odolnosti:</b> {{ m.damage_resistances.join(', ') }}</div> }
          @if (m.damage_immunities?.length)      { <div class="m-prop"><b>Imunity (po≈°kozen√≠):</b> {{ m.damage_immunities.join(', ') }}</div> }
          @if (m.condition_immunities?.length)   { <div class="m-prop"><b>Imunity (stavy):</b> {{ conditionNames(m) }}</div> }
          @if (m.senses)                         { <div class="m-prop"><b>Smysly:</b> {{ sensesText(m) }}</div> }
          @if (m.languages)                      { <div class="m-prop"><b>Jazyky:</b> {{ m.languages }}</div> }

          <!-- Special abilities -->
          @if (m.special_abilities?.length) {
            <div class="m-rule"></div>
            <div class="m-section">Speci√°ln√≠ schopnosti</div>
            @for (a of m.special_abilities; track a.name) {
              <p class="m-ability"><b class="m-ability__name">{{ a.name }}.</b> {{ a.desc }}</p>
            }
          }

          <!-- Actions -->
          @if (m.actions?.length) {
            <div class="m-rule"></div>
            <div class="m-section">Akce</div>
            @for (a of m.actions; track a.name) {
              <p class="m-ability">
                <b class="m-ability__name">{{ a.name }}.</b> {{ a.desc }}
                @if (a.attack_bonus != null) { <span class="m-tag">+{{ a.attack_bonus }} k z√°sahu</span> }
                @if (a.dc) { <span class="m-tag">SO {{ a.dc.dc_value }} {{ a.dc.dc_type.name }}</span> }
              </p>
            }
          }

          <!-- Legendary actions -->
          @if (m.legendary_actions?.length) {
            <div class="m-rule"></div>
            <div class="m-section">Legend√°rn√≠ akce</div>
            @for (a of m.legendary_actions; track a.name) {
              <p class="m-ability"><b class="m-ability__name">{{ a.name }}.</b> {{ a.desc }}</p>
            }
          }

          <!-- Reactions -->
          @if (m.reactions?.length) {
            <div class="m-rule"></div>
            <div class="m-section">Reakce</div>
            @for (a of m.reactions; track a.name) {
              <p class="m-ability"><b class="m-ability__name">{{ a.name }}.</b> {{ a.desc }}</p>
            }
          }

          @if (m.image) {
            <div class="m-rule"></div>
            <img class="m-image" [src]="'https://www.dnd5eapi.co' + m.image" [alt]="m.name" />
          }
        }
      </div>
    }

  </div>
</div>

